// Copyright (c) Microsoft. All rights reserved. Licensed under the MIT license. See LICENSE file in the project root for full license information.
var opCommon = require('./op.common.js');

exports.transform = function (model) {
  model.layout = model.layout || "Conceptual";
  model.pagetype = "Conceptual";
  model.dev_langs = model.langs;

  var canonicalUrl;
  if (model._op_canonicalUrlPrefix && model._path) {
    canonicalUrl = opCommon.getCanonicalUrl(model._op_canonicalUrlPrefix, model._path, model.layout);
  }
  model.canonical_url = canonicalUrl;

  model.toc_asset_id = model.toc_asset_id || model._tocPath;
  model.toc_rel = model._tocRel;
  if (typeof templateUtility !== 'undefined' && model.breadcrumb_path && model._path) {
    model.breadcrumb_path = templateUtility.resolveSourceRelativePath(model.breadcrumb_path, model._path);
  }

  // there should be a better way too get this value
  var _op_isLocalBuild = false;
  /*
  if (model._op_themeFolder !== undefined && model._op_themeFolder.substring(0, 9) === 'C:\\users\\') {
	  _op_isLocalBuild = true;
  } */

  // Clean up unused predefined properties
  var resetKeys = [
    "conceptual",
    "remote",
    "path",
    "type",
    "source",
    "newFileRepository",
    "_baseDirectory",
    "_displayLangs",
    "gitContribute",
    "_gitContribute"
  ];
  model = opCommon.resetKeysAndSystemAttributes(model, resetKeys, true);

  if(typeof(model.title) !== 'undefined' && model.title != null) { 
    var pipeIndex = model.title.indexOf("|");
    if (pipeIndex > -1) {
      model._op_ogTitle = model.title.substring(0, pipeIndex).trim();
    } else {
      model._op_ogTitle = model.title;
    }
  } else {
    model._op_ogTitle = "";
  } 

  // For metadata consumed by docs themes, rename with prefix "_op_"
  var metaForThemes = ["wordCount", "rawTitle", "appliesto", "searchScope", "brand"];
  for (var index = 0; index < metaForThemes.length; ++index) {
    var meta = metaForThemes[index];
    model["_op_".concat(meta)] = model[meta];
    model[meta] = undefined;
  }
  model._op_canonicalUrl = canonicalUrl;
  model._op_isLocalBuild = _op_isLocalBuild;
  return {
    content: JSON.stringify(model)
  };
}
